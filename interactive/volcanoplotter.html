<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Volcano Plot</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #666; }
        input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 80px; }
        input[type="file"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #1d4ed8; }
        button.secondary { background: #64748b; }
        #plot { width: 100%; height: 700px; }
        .instructions { font-size: 14px; color: #555; margin-bottom: 15px; background: #eef2ff; padding: 15px; border-radius: 4px; border-left: 4px solid #2563eb; }
        
        /* Stats Dashboard Styles */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 6px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center; }
        .stat-card.red { border-top: 4px solid #E04F5F; }
        .stat-card.blue { border-top: 4px solid #3D7EA6; }
        .stat-card.grey { border-top: 4px solid #D3D3D3; }
        .stat-value { font-size: 24px; font-weight: bold; margin: 5px 0; color: #1e293b; }
        .stat-label { font-size: 12px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Interactive RNA-seq Volcano Plot</h1>
    
    <div class="instructions">
        <strong>How to use:</strong> Upload a CSV file. It must have at least three columns: 
        1. Gene Name 
        2. Log2 Fold Change 
        3. FDR (or adjusted p-value). 
        <br>The tool will automatically calculate the -log10(FDR) for you.
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Upload Data (CSV)</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
        <div class="control-group">
            <label>FDR Threshold</label>
            <input type="number" id="fdrCutoff" value="0.05" step="0.01">
        </div>
        <div class="control-group">
            <label>Log2FC Threshold</label>
            <input type="number" id="fcCutoff" value="1.0" step="0.1">
        </div>
        <div class="control-group" style="justify-content: flex-end;">
            <label>&nbsp;</label>
            <button onclick="processData()">Update Plot</button>
        </div>
        <div class="control-group" style="justify-content: flex-end;">
            <label>&nbsp;</label>
            <button class="secondary" onclick="loadMockData()">Use Demo Data</button>
        </div>
    </div>

    <!-- New Stats Dashboard -->
    <div class="stats-grid">
        <div class="stat-card red">
            <div class="stat-label">Upregulated</div>
            <div class="stat-value" id="count-up">0</div>
        </div>
        <div class="stat-card blue">
            <div class="stat-label">Downregulated</div>
            <div class="stat-value" id="count-down">0</div>
        </div>
        <div class="stat-card grey">
            <div class="stat-label">Not Significant</div>
            <div class="stat-value" id="count-ns">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Genes</div>
            <div class="stat-value" id="count-total">0</div>
        </div>
    </div>

    <div id="plot"></div>
</div>

<script>
    let currentData = [];

    // Standard column name guessing
    const colAliases = {
        gene: ['gene', 'symbol', 'gene_name', 'genename', 'id', 'geneid'],
        fc: ['log2foldchange', 'log2fc', 'logfc', 'fc'],
        fdr: ['fdr', 'padj', 'p-adj', 'adj.p.val', 'qvalue', 'pvalue_adj']
    };

    function findColumn(headers, aliases) {
        const lowerHeaders = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ''));
        for (let alias of aliases) {
            const index = lowerHeaders.indexOf(alias);
            if (index !== -1) return headers[index];
        }
        return null;
    }

    function loadMockData() {
        // Generate 3000 points
        const mock = [];
        for (let i = 0; i < 3000; i++) {
            const fc = (Math.random() * 8) - 4; // -4 to 4
            // Skew P-values: if FC is high, make P-value likely lower
            let p = Math.random();
            if (Math.abs(fc) > 1.5) p = p / 100;
            if (Math.abs(fc) > 3) p = p / 1000;
            
            mock.push({
                Gene: `Gene_${i}`,
                log2FoldChange: fc,
                padj: p
            });
        }
        currentData = mock;
        renderPlot(mock, 'Gene', 'log2FoldChange', 'padj');
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                const headers = results.meta.fields;
                const geneCol = findColumn(headers, colAliases.gene);
                const fcCol = findColumn(headers, colAliases.fc);
                const fdrCol = findColumn(headers, colAliases.fdr);

                if (!fcCol || !fdrCol) {
                    alert(`Could not auto-detect columns. Please ensure your CSV headers contain "Log2FoldChange" and "FDR" or "padj". Found: ${headers.join(', ')}`);
                    return;
                }

                currentData = results.data;
                renderPlot(currentData, geneCol || headers[0], fcCol, fdrCol);
            }
        });
    });

    function processData() {
        // Trigger re-render with current settings if data exists
        const fileInput = document.getElementById('csvFile');
        if (currentData.length > 0) {
             // Re-guessing columns is inefficient here but keeps code simple for the single-file constraint
             // In a real app we would store the identified columns
             const headers = Object.keys(currentData[0]);
             const geneCol = findColumn(headers, colAliases.gene) || headers[0];
             const fcCol = findColumn(headers, colAliases.fc);
             const fdrCol = findColumn(headers, colAliases.fdr);
             renderPlot(currentData, geneCol, fcCol, fdrCol);
        }
    }

    function renderPlot(data, geneKey, fcKey, fdrKey) {
        const fdrThresh = parseFloat(document.getElementById('fdrCutoff').value);
        const fcThresh = parseFloat(document.getElementById('fcCutoff').value);
        const negLogFdrThresh = -Math.log10(fdrThresh);

        const upReg = { x: [], y: [], text: [], mode: 'markers', name: 'Upregulated', type: 'scatter', marker: { color: '#E04F5F', size: 8 } };
        const downReg = { x: [], y: [], text: [], mode: 'markers', name: 'Downregulated', type: 'scatter', marker: { color: '#3D7EA6', size: 8 } };
        const notSig = { x: [], y: [], text: [], mode: 'markers', name: 'Not Significant', type: 'scatter', marker: { color: '#D3D3D3', size: 6 } };

        data.forEach(row => {
            const fc = row[fcKey];
            const fdr = row[fdrKey];
            
            if (fc === null || fdr === null || isNaN(fc) || isNaN(fdr)) return;

            // Avoid log(0) infinity
            const cleanFdr = fdr === 0 ? 1e-300 : fdr;
            const negLogFdr = -Math.log10(cleanFdr);
            
            const geneName = row[geneKey] || 'Unknown';
            const hoverText = `${geneName}<br>Log2FC: ${fc.toFixed(3)}<br>FDR: ${fdr.toExponential(3)}`;

            if (fdr < fdrThresh && fc > fcThresh) {
                upReg.x.push(fc);
                upReg.y.push(negLogFdr);
                upReg.text.push(hoverText);
            } else if (fdr < fdrThresh && fc < -fcThresh) {
                downReg.x.push(fc);
                downReg.y.push(negLogFdr);
                downReg.text.push(hoverText);
            } else {
                notSig.x.push(fc);
                notSig.y.push(negLogFdr);
                notSig.text.push(hoverText);
            }
        });

        // Update Status Dashboard
        document.getElementById('count-up').textContent = upReg.x.length.toLocaleString();
        document.getElementById('count-down').textContent = downReg.x.length.toLocaleString();
        document.getElementById('count-ns').textContent = notSig.x.length.toLocaleString();
        document.getElementById('count-total').textContent = (upReg.x.length + downReg.x.length + notSig.x.length).toLocaleString();

        const layout = {
            hovermode: 'closest',
            xaxis: { title: 'Log2 Fold Change', zeroline: false },
            yaxis: { title: '-log10(FDR)', zeroline: false },
            shapes: [
                // Horizontal FDR line
                {
                    type: 'line',
                    x0: 0, x1: 1, xref: 'paper',
                    y0: negLogFdrThresh, y1: negLogFdrThresh, yref: 'y',
                    line: { color: 'black', width: 1, dash: 'dash' }
                },
                // Vertical +FC line
                {
                    type: 'line',
                    x0: fcThresh, x1: fcThresh, xref: 'x',
                    y0: 0, y1: 1, yref: 'paper',
                    line: { color: 'black', width: 1, dash: 'dot' }
                },
                // Vertical -FC line
                {
                    type: 'line',
                    x0: -fcThresh, x1: -fcThresh, xref: 'x',
                    y0: 0, y1: 1, yref: 'paper',
                    line: { color: 'black', width: 1, dash: 'dot' }
                }
            ],
            annotations: [
                { x: fcThresh, y: 0, xref: 'x', yref: 'paper', text: `+${fcThresh}`, showarrow: false, yanchor: 'bottom', xanchor: 'left', font: {size: 10} },
                { x: 1, y: negLogFdrThresh, xref: 'paper', yref: 'y', text: `FDR ${fdrThresh}`, showarrow: false, yanchor: 'bottom', xanchor: 'right', font: {size: 10} }
            ]
        };

        Plotly.newPlot('plot', [notSig, upReg, downReg], layout);
    }

    // Init with demo data
    window.onload = loadMockData;
</script>

</body>
</html>
